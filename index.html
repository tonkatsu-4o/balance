import React, { useState, useEffect, useMemo } from 'react';
import { Terminal, Folder, FileText, ChevronRight, ChevronDown, Home, Atom, Cpu, Search, Menu, X } from 'lucide-react';

/**
 * ==========================================
 * ユーザー設定エリア：記事データ (Article Data)
 * ==========================================
 * ここに記事を追加していくことで、自動的にサイドバーの階層が生成されます。
 * content内ではLaTeX形式 ($...$ または $$...$$) が使用可能です。
 */
const articles = [
  {
    id: 'intro',
    path: 'General/Introduction',
    title: 'Welcome to FutureWiki',
    date: '2026-01-28',
    content: `
      <h2>システム概要</h2>
      <p>このシステムは、GitHub Pagesでの運用を想定した静的ナレッジベースです。Reactベースで構築されており、高速なページ遷移と美しい数式表示を実現しています。</p>
      
      <h3>主な機能</h3>
      <ul>
        <li>階層構造の自動生成</li>
        <li>リアルタイム検索</li>
        <li>LaTeX数式レンダリング</li>
      </ul>
    `
  },
  {
    id: 'math-sample',
    path: 'Science/Mathematics/Linear Algebra',
    title: '固有値と固有ベクトル',
    date: '2026-02-15',
    content: `
      <p>線形代数における固有値問題は、次の方程式で定義されます。</p>
      
      $$ A \\mathbf{x} = \\lambda \\mathbf{x} $$
      
      <p>ここで、$A$ は $n \\times n$ 行列、$\\mathbf{x}$ はゼロでないベクトル（固有ベクトル）、$\\lambda$ はスカラー（固有値）です。</p>
      
      <p>特性方程式 $\\det(A - \\lambda I) = 0$ を解くことで固有値を求めることができます。</p>
    `
  },
  {
    id: 'physics-sample',
    path: 'Science/Physics/Quantum Mechanics',
    title: 'シュレーディンガー方程式',
    date: '2026-03-01',
    content: `
      <p>量子力学の基礎となるシュレーディンガー方程式は、時間依存型と非依存型があります。</p>
      
      <h3>時間依存シュレーディンガー方程式</h3>
      $$ i \\hbar \\frac{\\partial}{\\partial t} \\Psi(\\mathbf{r}, t) = \\hat{H} \\Psi(\\mathbf{r}, t) $$
      
      <p>これは、量子系における波動関数 $\\Psi$ の時間発展を記述します。</p>
    `
  },
  {
    id: 'tech-design',
    path: 'Engineering/Web/Design System',
    title: 'Neon UI Principles',
    date: '2026-04-10',
    content: `
      <p>近未来的なUIデザインには、以下の要素が不可欠です。</p>
      <ul>
        <li>高いコントラスト比</li>
        <li>発光表現（Glow Effects）</li>
        <li>半透明な背景（Glassmorphism）</li>
        <li>等幅フォントの使用</li>
      </ul>
    `
  }
];

/**
 * ==========================================
 * ユーザー設定エリア：トップページ (Home Data)
 * ==========================================
 * トップページに表示するメッセージやコンテンツを設定します。
 * HTMLタグが使用可能です。
 */
const homeConfig = {
  title: "FUTURE_WIKI",
  subtitle: "Knowledge Base System v2.0.26",
  // ここにトップページの本文を記述します
  description: `
    <p class="text-lg mb-4">ようこそ、個人のナレッジベースへ。</p>
    <p class="mb-2">ここは、日々の学習記録、技術メモ、そしてアイデアの断片を蓄積するための空間です。</p>
    <p class="text-slate-400 text-sm">左上のメニューボタン、または検索バーから記事を探してみてください。</p>
  `
};

/**
 * ==========================================
 * システムコンポーネント (System Components)
 * ==========================================
 */

// KaTeXの読み込みとレンダリングを行うフック
const useKaTeX = () => {
  const [isLoaded, setIsLoaded] = useState(false);

  useEffect(() => {
    // スタイルシートの注入
    const link = document.createElement('link');
    link.href = "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css";
    link.rel = "stylesheet";
    link.integrity = "sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV";
    link.crossOrigin = "anonymous";
    document.head.appendChild(link);

    // スクリプトの注入
    const script = document.createElement('script');
    script.src = "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js";
    script.integrity = "sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8";
    script.crossOrigin = "anonymous";
    script.onload = () => {
      // Auto-render拡張機能の読み込み
      const autoRenderScript = document.createElement('script');
      autoRenderScript.src = "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js";
      autoRenderScript.integrity = "sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05";
      autoRenderScript.crossOrigin = "anonymous";
      autoRenderScript.onload = () => setIsLoaded(true);
      document.head.appendChild(autoRenderScript);
    };
    document.head.appendChild(script);

    return () => {
      // クリーンアップ（簡易的）
      try {
        document.head.removeChild(link);
        document.head.removeChild(script);
      } catch (e) {
        // console.error(e);
      }
    };
  }, []);

  return isLoaded;
};

// 数式を含むコンテンツを表示するコンポーネント
const LatexContent = ({ content }) => {
  const isKaTeXLoaded = useKaTeX();
  const containerRef = React.useRef(null);

  useEffect(() => {
    if (isKaTeXLoaded && containerRef.current && window.renderMathInElement) {
      window.renderMathInElement(containerRef.current, {
        delimiters: [
          { left: '$$', right: '$$', display: true },
          { left: '$', right: '$', display: false },
        ],
        throwOnError: false
      });
    }
  }, [content, isKaTeXLoaded]);

  return (
    <div 
      ref={containerRef}
      className="prose prose-invert prose-p:text-slate-300 prose-headings:text-cyan-400 prose-strong:text-cyan-200 max-w-none font-sans break-words"
      dangerouslySetInnerHTML={{ __html: content }}
    />
  );
};

// ディレクトリツリーを生成するヘルパー関数
const buildDirectoryTree = (articles) => {
  const root = {};

  articles.forEach(article => {
    const parts = article.path.split('/');
    let current = root;

    parts.forEach((part, index) => {
      if (!current[part]) {
        current[part] = {
          name: part,
          type: index === parts.length - 1 ? 'file' : 'folder',
          children: {},
          articleId: index === parts.length - 1 ? article.id : null
        };
      }
      current = current[part].children;
    });
  });

  return root;
};

// 再帰的にツリーを表示するコンポーネント
const FileTree = ({ node, level = 0, onSelect, currentArticleId }) => {
  const [isOpen, setIsOpen] = useState(true); // デフォルトで展開
  const isFile = node.type === 'file';
  const paddingLeft = `${level * 16}px`;

  if (isFile) {
    const isActive = node.articleId === currentArticleId;
    return (
      <div 
        onClick={() => onSelect(node.articleId)}
        className={`
          flex items-center gap-2 py-3 md:py-1.5 px-2 cursor-pointer transition-colors duration-200
          hover:bg-cyan-900/30 text-sm group
          ${isActive ? 'bg-cyan-900/50 text-cyan-300 border-r-2 border-cyan-400' : 'text-slate-400'}
        `}
        style={{ paddingLeft: `calc(${paddingLeft} + 8px)` }}
      >
        <FileText size={16} className={isActive ? 'text-cyan-400' : 'text-slate-500 group-hover:text-cyan-400'} />
        <span className="truncate">{node.name}</span>
      </div>
    );
  }

  return (
    <div>
      <div 
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 py-3 md:py-1.5 px-2 cursor-pointer hover:bg-slate-800/50 text-slate-300 text-sm font-semibold select-none"
        style={{ paddingLeft }}
      >
        {isOpen ? <ChevronDown size={16} className="text-pink-500" /> : <ChevronRight size={16} className="text-slate-500" />}
        <Folder size={16} className="text-pink-500/80" />
        <span className="truncate">{node.name}</span>
      </div>
      {isOpen && (
        <div className="border-l border-slate-700/50 ml-3">
          {Object.values(node.children).map((child) => (
            <FileTree 
              key={child.name} 
              node={child} 
              level={level + 1} 
              onSelect={onSelect}
              currentArticleId={currentArticleId}
            />
          ))}
        </div>
      )}
    </div>
  );
};

// トップページのダッシュボード
const Dashboard = ({ stats, onRandom }) => {
  return (
    <div className="animate-fadeIn p-4 md:p-6">
      <div className="mb-12 text-center pt-8 md:pt-0">
        <h1 className="text-4xl md:text-7xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 mb-4 tracking-tight break-all" style={{fontFamily: 'monospace'}}>
          {homeConfig.title}
        </h1>
        <p className="text-slate-400 text-sm md:text-lg mb-8">{homeConfig.subtitle}</p>
        
        {/* ユーザー設定のウェルカムメッセージを表示 */}
        <div 
          className="max-w-2xl mx-auto bg-slate-800/30 border border-slate-700/50 rounded-xl p-6 text-slate-300 leading-relaxed text-left md:text-center"
          dangerouslySetInnerHTML={{ __html: homeConfig.description }}
        />
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-12">
        <div className="bg-slate-800/40 border border-slate-700 p-6 rounded-lg backdrop-blur-sm hover:border-cyan-500/50 transition-colors group">
          <div className="flex items-center gap-4 mb-3">
            <div className="p-3 rounded-full bg-cyan-900/30 group-hover:bg-cyan-900/50 transition-colors">
              <Atom className="text-cyan-400" size={24} />
            </div>
            <div className="text-2xl font-bold text-slate-200">{stats.totalArticles}</div>
          </div>
          <div className="text-slate-400 text-sm uppercase tracking-wider">Total Articles</div>
        </div>
        
        <div className="bg-slate-800/40 border border-slate-700 p-6 rounded-lg backdrop-blur-sm hover:border-pink-500/50 transition-colors group">
          <div className="flex items-center gap-4 mb-3">
            <div className="p-3 rounded-full bg-pink-900/30 group-hover:bg-pink-900/50 transition-colors">
              <Cpu className="text-pink-400" size={24} />
            </div>
            <div className="text-2xl font-bold text-slate-200">{stats.categories}</div>
          </div>
          <div className="text-slate-400 text-sm uppercase tracking-wider">Categories</div>
        </div>

        <div 
          onClick={onRandom}
          className="bg-slate-800/40 border border-slate-700 p-6 rounded-lg backdrop-blur-sm hover:border-green-500/50 transition-colors cursor-pointer group relative overflow-hidden"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000" />
          <div className="flex items-center gap-4 mb-3">
            <div className="p-3 rounded-full bg-green-900/30 group-hover:bg-green-900/50 transition-colors">
              <Search className="text-green-400" size={24} />
            </div>
            <div className="text-lg font-bold text-slate-200">Discover</div>
          </div>
          <div className="text-slate-400 text-sm uppercase tracking-wider">Random Article</div>
        </div>
      </div>
    </div>
  );
};

export default function App() {
  const [activeArticleId, setActiveArticleId] = useState(null);
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');

  // 画面サイズに応じて初期状態を設定
  useEffect(() => {
    const handleResize = () => {
      if (window.innerWidth < 768) {
        setSidebarOpen(false);
      } else {
        setSidebarOpen(true);
      }
    };
    
    // 初期実行
    if (window.innerWidth < 768) {
      setSidebarOpen(false);
    }

    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  // 記事データの処理
  const tree = useMemo(() => buildDirectoryTree(articles), []);
  
  // 検索フィルタリング
  const filteredArticles = useMemo(() => {
    if (!searchQuery) return [];
    return articles.filter(a => 
      a.title.toLowerCase().includes(searchQuery.toLowerCase()) || 
      a.content.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }, [searchQuery]);

  const activeArticle = useMemo(() => 
    articles.find(a => a.id === activeArticleId), 
  [activeArticleId]);

  const stats = useMemo(() => {
    const categories = new Set(articles.map(a => a.path.split('/')[0]));
    return {
      totalArticles: articles.length,
      categories: categories.size
    };
  }, []);

  const handleRandom = () => {
    const random = articles[Math.floor(Math.random() * articles.length)];
    setActiveArticleId(random.id);
    if (window.innerWidth < 768) setSidebarOpen(false);
  };

  return (
    <div className="min-h-screen bg-slate-900 text-slate-200 font-sans selection:bg-cyan-500/30 selection:text-cyan-100 overflow-hidden flex flex-col">
      {/* Background Effects */}
      <div className="fixed inset-0 pointer-events-none z-0">
        <div className="absolute inset-0 bg-[linear-gradient(rgba(18,18,23,0)_2px,transparent_2px),linear-gradient(90deg,rgba(18,18,23,0)_2px,transparent_2px)] bg-[size:40px_40px] [background-position:center] opacity-20 border-slate-700/20"></div>
        <div className="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-cyan-500/50 to-transparent"></div>
        <div className="absolute bottom-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-pink-500/50 to-transparent"></div>
        <div className="absolute inset-0 bg-slate-900/80"></div>
      </div>

      {/* Header */}
      <header className="relative z-30 h-16 border-b border-slate-800 bg-slate-900/90 backdrop-blur-md flex items-center justify-between px-4 shadow-[0_4px_20px_-10px_rgba(0,0,0,0.5)]">
        <div className="flex items-center gap-4">
          <button 
            onClick={() => setSidebarOpen(!sidebarOpen)}
            className="p-2 hover:bg-slate-800 rounded-md text-cyan-400 transition-colors z-50"
          >
            {sidebarOpen ? <X size={20} /> : <Menu size={20} />}
          </button>
          <div 
            onClick={() => {
              setActiveArticleId(null);
              if (window.innerWidth < 768) setSidebarOpen(false);
            }}
            className="flex items-center gap-2 cursor-pointer group"
          >
            <Terminal size={20} className="text-pink-500 group-hover:text-pink-400 transition-colors" />
            <span className="font-bold tracking-wider text-lg hidden sm:block font-mono group-hover:text-white transition-colors">
              F_WIKI<span className="animate-pulse text-cyan-400">_</span>
            </span>
          </div>
        </div>

        <div className="flex-1 max-w-md mx-4">
          <div className="relative group">
            <input
              type="text"
              placeholder="Search..."
              className="w-full bg-slate-800/50 border border-slate-700 rounded-full py-1.5 pl-10 pr-4 text-sm focus:outline-none focus:border-cyan-500/50 focus:bg-slate-800 transition-all text-slate-200 placeholder-slate-500"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
            <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-cyan-400 transition-colors" />
            
            {/* Search Dropdown */}
            {searchQuery && (
              <div className="absolute top-full mt-2 left-0 right-0 bg-slate-900 border border-slate-700 rounded-lg shadow-xl max-h-60 overflow-y-auto z-50">
                {filteredArticles.length > 0 ? (
                  filteredArticles.map(article => (
                    <div 
                      key={article.id}
                      onClick={() => {
                        setActiveArticleId(article.id);
                        setSearchQuery('');
                        if (window.innerWidth < 768) setSidebarOpen(false);
                      }}
                      className="px-4 py-3 hover:bg-slate-800 cursor-pointer border-b border-slate-800/50 last:border-0"
                    >
                      <div className="text-cyan-400 text-sm font-semibold">{article.title}</div>
                      <div className="text-slate-500 text-xs truncate">{article.path}</div>
                    </div>
                  ))
                ) : (
                  <div className="p-4 text-center text-slate-500 text-sm">No results found</div>
                )}
              </div>
            )}
          </div>
        </div>

        <div className="flex items-center gap-2 text-xs text-slate-500 font-mono hidden sm:block">
          SYS: ONLINE
          <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
        </div>
      </header>

      {/* Main Content Area */}
      <div className="flex-1 flex overflow-hidden relative z-10">
        
        {/* Mobile Overlay */}
        {sidebarOpen && (
          <div 
            className="fixed inset-0 bg-black/60 backdrop-blur-sm z-20 md:hidden animate-fadeIn"
            onClick={() => setSidebarOpen(false)}
          />
        )}

        {/* Sidebar */}
        <aside 
          className={`
            fixed md:relative z-30 top-16 md:top-0 bottom-0 w-[80%] max-w-sm md:w-72 
            bg-slate-900 md:bg-slate-900/50 border-r border-slate-800 backdrop-blur-md
            transition-all duration-300 ease-in-out transform shadow-2xl md:shadow-none
            ${sidebarOpen ? 'translate-x-0' : '-translate-x-full md:w-0 md:border-r-0 md:translate-x-0 overflow-hidden'}
          `}
        >
          <div className="h-full overflow-y-auto p-4 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent">
            <div className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 font-mono">
              / Root Directory
            </div>
            {Object.values(tree).map((node) => (
              <FileTree 
                key={node.name} 
                node={node} 
                onSelect={(id) => {
                  setActiveArticleId(id);
                  if (window.innerWidth < 768) setSidebarOpen(false);
                }} 
                currentArticleId={activeArticleId}
              />
            ))}
          </div>
        </aside>

        {/* Article View */}
        <main className="flex-1 overflow-y-auto relative scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent w-full">
          <div className="max-w-4xl mx-auto p-4 md:p-12 min-h-full pb-24">
            {!activeArticle ? (
              <Dashboard stats={stats} onRandom={handleRandom} />
            ) : (
              <div className="animate-fadeIn">
                {/* Breadcrumb */}
                <div className="flex flex-wrap items-center gap-2 text-xs text-cyan-500/70 font-mono mb-6">
                  <Home size={12} className="cursor-pointer hover:text-cyan-400" onClick={() => setActiveArticleId(null)} />
                  {activeArticle.path.split('/').map((part, i) => (
                    <React.Fragment key={i}>
                      <span>/</span>
                      <span className={i === activeArticle.path.split('/').length - 1 ? 'text-cyan-300' : ''}>{part}</span>
                    </React.Fragment>
                  ))}
                </div>

                {/* Article Header */}
                <header className="mb-8 border-b border-slate-800 pb-8">
                  <h1 className="text-2xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-slate-100 to-slate-400 mb-4 leading-tight">
                    {activeArticle.title}
                  </h1>
                  <div className="flex flex-col md:flex-row md:items-center gap-2 md:gap-4 text-xs md:text-sm text-slate-500 font-mono">
                    <span className="flex items-center gap-1">
                      <Terminal size={14} /> ID: {activeArticle.id}
                    </span>
                    <span className="hidden md:inline w-px h-4 bg-slate-700"></span>
                    <span>UPDATED: {activeArticle.date}</span>
                  </div>
                </header>

                {/* Content */}
                <div className="bg-slate-800/20 rounded-lg border border-slate-800 p-4 md:p-8 shadow-inner relative overflow-hidden">
                  <div className="absolute top-0 right-0 p-2 opacity-10 pointer-events-none">
                    <Atom size={100} />
                  </div>
                  <LatexContent content={activeArticle.content} />
                </div>
              </div>
            )}
          </div>
          
          {/* Footer */}
          <footer className="absolute bottom-0 left-0 right-0 p-4 text-center text-[10px] md:text-xs text-slate-600 font-mono border-t border-slate-800/50 bg-slate-900/80 backdrop-blur">
            FUTURE_WIKI SYSTEM &copy; 2026 // RENDERED IN {new Date().getFullYear()}
          </footer>
        </main>
      </div>
    </div>
  );
}
